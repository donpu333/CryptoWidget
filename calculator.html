<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tools - Calculator & Signals</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2196F3;
            --secondary: #1976D2;
            --accent-red: #C62828;
            --accent-green: #2E7D32;
            --accent-orange: #FF6D00;
            --dark: #121212;
            --light: #ffffff;
            --success-color: #03DAC6;
            --warning-color: #FFA000;
            --teal-accent: #4CAF50;
            --green-gradient-start: #4CAF50;
            --green-gradient-end: #2E7D32;
            --red-gradient-start: #F44336;
            --red-gradient-end: #C62828;
            --border-radius: 12px;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--dark);
            color: var(--light);
        }

        .btn-primary {
            background-color: var(--primary);
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(33, 150, 243, 0.3);
        }

        .card {
            background-color: #1E1E1E;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        nav {
            background-color: #1E1E1E;
            border-bottom: 1px solid #2D2D2D;
        }

        footer {
            background-color: #1E1E1E;
            border-top: 1px solid #2D2D2D;
        }

        .calculator-container {
            background-color: #1E1E1E;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(33, 150, 243, 0.2);
            margin-bottom: 20px;
            height: 100%;
        }

        .section {
            margin-bottom: 15px;
            padding: 12px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1rem;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #9CA3AF;
        }

        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #2D2D2D;
            border: 1px solid #3D3D3D;
            color: white;
            font-family: 'JetBrains Mono', monospace;
        }

        .input-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #3D3D3D;
            border-radius: 3px;
            outline: none;
            margin: 10px 0;
        }

        .input-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .input-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .direction-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            background: #2A2A2A;
            padding: 5px;
            border-radius: 10px;
        }

        .direction-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            position: relative;
            overflow: hidden;
        }

        .long {
            background: transparent;
            color: #A5D6A7;
        }

        .short {
            background: transparent;
            color: #EF9A9A;
        }

        .direction-btn.active {
            color: white;
        }

        .long.active {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }

        .short.active {
            background: linear-gradient(135deg, #F44336 0%, #C62828 100%);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .result-value {
            font-weight: 500;
        }

        .profit {
            color: var(--success-color);
        }

        .loss {
            color: var(--accent-red);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider-value {
            min-width: 30px;
            text-align: right;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .preview-value {
            color: var(--warning-color);
            font-size: 0.8rem;
            margin-top: 5px;
            padding: 4px;
            background-color: rgba(255, 160, 0, 0.1);
            border-radius: 4px;
        }

        .leverage-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leverage-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            background-color: rgba(33, 150, 243, 0.1);
            padding: 4px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .leverage-warning {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 5px;
            padding: 4px;
            background-color: rgba(207, 102, 121, 0.1);
            border-radius: 4px;
            display: none;
        }

        .export-btn {
            width: 100%;
            padding: 10px 15px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 20px;
            text-align: center;
        }

        .export-btn:hover {
            background: #1976D2;
        }

        .main-header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--accent-color);
            font-weight: 600;
            font-size: 2rem;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .menu-container {
            position: relative;
            display: inline-block;
        }

        .menu-button {
            background-color: transparent;
            color: white;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .menu-button:hover {
            color: var(--primary);
        }

        .menu-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #1E1E1E;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            border: 1px solid #3D3D3D;
        }

        .menu-content.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .menu-item {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            transition: background-color 0.3s;
        }

        .menu-item:hover {
            background-color: #2D2D2D;
            color: var(--primary);
        }

        .menu-divider {
            height: 1px;
            background-color: #3D3D3D;
            margin: 4px 0;
        }

        .auth-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .auth-button {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button {
            background-color: transparent;
            color: white;
            border: 1px solid #3D3D3D;
        }

        .login-button:hover {
            background-color: rgba(33, 150, 243, 0.1);
            border-color: var(--primary);
        }

        .register-button {
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .register-button:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }

        .take-profit-levels {
            margin-top: 10px;
        }

        .take-profit-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px;
            background-color: rgba(0, 255, 0, 0.05);
            border-radius: 3px;
        }

        .take-profit-ratio {
            color: var(--success-color);
            font-weight: 500;
        }

        .take-profit-price {
            color: var(--success-color);
        }

        .take-profit-value {
            color: var(--success-color);
        }

        .stop-method-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            background: #2A2A2A;
            padding: 5px;
            border-radius: 10px;
        }

        .stop-method-btn {
            flex: 1;
            padding: 8px 0;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            background-color: transparent;
            color: #9CA3AF;
        }

        .stop-method-btn.active {
            background-color: rgba(33, 150, 243, 0.2);
            color: var(--primary);
        }

        .stop-input-group {
            display: none;
        }

        .stop-input-group.active {
            display: block;
        }

        .trade-type-selector {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .trade-type-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.05);
            color: #9CA3AF;
            transition: all 0.3s;
        }

        .trade-type-btn.active {
            color: white;
        }

        .trade-type-btn.long-breakout.active {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }

        .trade-type-btn.long-fakeout.active {
            background: linear-gradient(135deg, #8BC34A 0%, #689F38 100%);
        }

        .trade-type-btn.short-breakout.active {
            background: linear-gradient(135deg, #F44336 0%, #C62828 100%);
        }

        .trade-type-btn.short-fakeout.active {
            background: linear-gradient(135deg, #FF7043 0%, #E64A19 100%);
        }

        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .export-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .export-modal-content {
            background-color: #1E1E1E;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .export-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .export-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .export-modal-close {
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            top: -10px;
            right: -10px;
        }

        .export-modal-body {
            margin-bottom: 20px;
        }

        .export-modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .export-modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-modal-btn-copy {
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .export-modal-btn-copy:hover {
            background-color: var(--secondary);
        }

        .export-modal-btn-close {
            background-color: transparent;
            color: #9CA3AF;
            border: 1px solid #3D3D3D;
        }

        .export-modal-btn-close:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .telegram-settings-form {
            margin-top: 15px;
        }

        .telegram-settings-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #9CA3AF;
        }

        .telegram-settings-form input {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            background-color: #2D2D2D;
            border: 1px solid #3D3D3D;
            color: white;
            font-family: 'JetBrains Mono', monospace;
        }

        .telegram-settings-form button {
            width: 100%;
            padding: 10px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .telegram-settings-form button:hover {
            background-color: var(--secondary);
        }

        .telegram-test-btn {
            margin-top: 10px;
            background-color: #4CAF50 !important;
        }

        .telegram-test-btn:hover {
            background-color: #2E7D32 !important;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1100;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Стили для раздела предпосылок */
        .premises-container {
            background-color: #1E1E1E;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(33, 150, 243, 0.2);
            height: 100%;
        }

        .button-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .button-container button {
            background-color: #1E88E5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            font-family: 'JetBrains Mono', monospace;
        }

        .button-container button:hover {
            background-color: #1565C0;
        }

        .text-display {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-line;
            display: none;
            margin-top: 15px;
            border: 1px solid #3D3D3D;
            max-height: none;
            overflow-y: visible;
        }

        .action-btn {
            background-color: #4CAF50;
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
        }

        .action-btn:hover {
            background-color: #45a049;
        }

        .export-btn-premises {
            background-color: #2196F3;
        }

        .export-btn-premises:hover {
            background-color: #0b7dda;
        }

        .reset-btn {
            background-color: #FF9800;
        }

        .reset-btn:hover {
            background-color: #F57C00;
        }

        .action-buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            display: none;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-item input {
            margin-right: 10px;
            cursor: pointer;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .success {
            background-color: #2E7D32;
            color: white;
        }

        .error {
            background-color: #C62828;
            color: white;
        }

        .item-text {
            margin-left: 5px;
        }

        .tvh-sub-buttons {
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .tvh-sub-buttons button {
            background-color: #757575;
            padding: 8px 16px;
            font-size: 14px;
        }

        .tvh-sub-buttons button:hover {
            background-color: #616161;
        }

        /* Оверлей и контейнер для ТВХ текста */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
        }

        .tvh-text-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(30, 30, 30, 0.95);
            padding: 30px;
            border-radius: 8px;
            max-width: 80%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            border: 1px solid #3D3D3D;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .tvh-text-content h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .tvh-text-content p {
            margin-bottom: 10px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .tvh-text-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .tvh-copy-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .tvh-copy-btn:hover {
            background-color: var(--secondary);
        }
        
        /* Новые стили для процентов */
        .percentage-value {
            font-size: 0.8rem;
            color: #9CA3AF;
            margin-left: 5px;
        }
        
        /* Стили для комиссии */
        .fee-value {
            color: var(--warning-color);
            font-weight: 500;
        }
        
        /* Стили для убытка в USDT */
        .loss-usdt {
            color: var(--accent-red);
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        /* Стили для автоматического определения знаков после запятой */
        .decimals-info {
            font-size: 0.8rem;
            color: var(--primary);
            margin-top: 5px;
            padding: 4px;
            background-color: rgba(33, 150, 243, 0.1);
            border-radius: 4px;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* Стили для встроенных фото в ТВХ тексте */
        .embedded-photos {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .embedded-photo {
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 2px solid #3D3D3D;
        }

        .embedded-photo:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .photo-section {
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .photo-section-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 1rem;
        }

        /* Стили для модального окна с фото */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px;
        }

        .photo-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .photo-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .photo-image-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .photo-image-fit {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: transform 0.3s ease;
            transform-origin: center center;
        }

        .photo-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 2001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-navigation {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            align-items: center;
            z-index: 2001;
        }

        .nav-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn:hover {
            background-color: var(--secondary);
        }

        .nav-btn:disabled {
            background-color: #757575;
            cursor: not-allowed;
        }

        .photo-counter {
            color: white;
            padding: 0 10px;
            font-size: 0.9rem;
        }

        .zoom-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 2001;
        }

        .zoom-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .zoom-btn:hover {
            background-color: var(--secondary);
        }

        .zoom-reset-btn {
            background-color: #FF9800;
        }

        .zoom-reset-btn:hover {
            background-color: #F57C00;
        }

        .photo-thumbnails {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-width: 90%;
            overflow-x: auto;
            z-index: 2001;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .thumbnail.active {
            opacity: 1;
            border: 2px solid var(--primary);
        }

        .thumbnail:hover {
            opacity: 0.8;
        }

        /* Стили для полноэкранного режима */
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 80px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 2001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-modal.fullscreen {
            padding: 0;
        }

        .photo-modal.fullscreen .photo-container {
            width: 100vw;
            height: 100vh;
        }

        .photo-modal.fullscreen .photo-image-container {
            width: 100vw;
            height: 100vh;
        }

        .photo-modal.fullscreen .photo-image-fit {
            max-width: 100vw;
            max-height: 100vh;
        }

        /* Стили для перетаскивания изображения */
        .photo-container.dragging {
            cursor: grabbing;
        }

        .photo-image.dragging {
            cursor: grabbing;
        }

        /* Стили для алгоритма */
        .algorithm-sub-buttons {
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .algorithm-sub-buttons button {
            background-color: #757575;
            padding: 8px 16px;
            font-size: 14px;
        }

        .algorithm-sub-buttons button:hover {
            background-color: #616161;
        }

        /* Стили для улучшенного отображения ТВХ текста */
        .tvh-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .tvh-content::-webkit-scrollbar {
            width: 8px;
        }

        .tvh-content::-webkit-scrollbar-track {
            background: #2D2D2D;
            border-radius: 4px;
        }

        .tvh-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .tvh-content::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .photo-gallery-item {
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
            aspect-ratio: 4/3;
        }

        .photo-gallery-item:hover {
            transform: scale(1.05);
        }

        .photo-gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-gallery-caption {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            font-size: 0.7rem;
            text-align: center;
        }

        /* Стили для кнопок фото в ТВХ тексте */
        .photo-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            margin: 10px 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .photo-btn:hover {
            background-color: var(--secondary);
        }

        .photo-btn-long {
            background-color: #4CAF50;
        }

        .photo-btn-long:hover {
            background-color: #2E7D32;
        }

        .photo-btn-short {
            background-color: #F44336;
        }

        .photo-btn-short:hover {
            background-color: #C62828;
        }

        /* Стили для кнопки возврата */
        .back-button {
            background-color: #FF9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-button:hover {
            background-color: #F57C00;
        }
    </style>
</head>
<body class="bg-dark">
    <div class="notification" id="notification"></div>

    <nav class="shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <i class="fas fa-calculator text-primary text-xl mr-2"></i>
                    <span class="text-xl font-bold text-light">Crypto Tools</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="menu-container">
                        <button class="menu-button" id="menuButton" onclick="toggleMenu()">
                            <i class="fas fa-bars mr-2"></i>Меню
                        </button>
                        <div class="menu-content" id="menuContent">
                            <a href="index.html" class="menu-item">
                                 <i class="fas fa-bell mr-2"></i>Алерт
                            </a>
                            <a href="calculator.html" class="menu-item">
                                <i class="fas fa-calculator mr-2"></i>Калькулятор
                            </a>
                           <a href="Chart.html" class="menu-item">
                            <i class="fas fa-chart-bar mr-2"></i>График
                             </a>
                            <a href="widget.html" class="menu-item">
                                <i class="fas fa-th-large mr-2"></i>Виджет
                            </a>
                            	<a href="Lider.html" class="menu-item">
	                        <i class="fas fa-chart-line mr-2"></i>Лидер роста и падения
	                        </a>
							<a href="Slide show.html" class="menu-item">
                                <i class="fas fa-images mr-2"></i>Слайд-шоу
                            </a>
                            <div class="menu-divider"></div>
                            <a href="#" class="menu-item" onclick="showLoginForm()" id="loginMenuItem">
                                <i class="fas fa-sign-in-alt mr-2"></i>Вход
                            </a>
                            <a href="#" class="menu-item" onclick="showRegisterForm()" id="registerMenuItem">
                                <i class="fas fa-user-plus mr-2"></i>Регистрация
                            </a>
                            <a href="#" class="menu-item hidden" onclick="handleLogout()" id="logoutMenuItem">
                                <i class="fas fa-sign-out-alt mr-2"></i>Выход
                            </a>
                        </div>
                    </div>
                    <button id="userProfileBtn" class="hidden items-center text-gray-300 hover:text-white">
                        <img id="userAvatar" class="w-8 h-8 rounded-full mr-2" src="https://via.placeholder.com/32/2D2D2D/6B7280?text=U" alt="User">
                        <span id="userName">Гость</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="w-full px-4 py-8">
        <div class="main-container">
            <!-- Калькулятор рисков (левая колонка) -->
            <div class="calculator-container risk-calculator">
                <h1>Калькулятор рисков</h1>

                <div class="section">
                    <div class="section-title">Параметры сделки</div>

                    <div class="direction-buttons">
                        <button id="longBtn" class="direction-btn long active">Лонг</button>
                        <button id="shortBtn" class="direction-btn short">Шорт</button>
                    </div>

                    <!-- Выбор типа сделки -->
                    <div class="trade-type-selector" id="tradeTypeSelector">
                        <button class="trade-type-btn long-breakout active" data-type="long-breakout">Лонг Пробой</button>
                        <button class="trade-type-btn long-fakeout" data-type="long-fakeout">Лонг Ложный пробой</button>
                        <button class="trade-type-btn short-breakout" data-type="short-breakout">Шорт Пробой</button>
                        <button class="trade-type-btn short-fakeout" data-type="short-fakeout">Шорт Ложный пробой</button>
                    </div>

                    <div class="input-group">
                        <label for="assetType">Точность цены (знаков после запятой)</label>
                        <select id="assetType">
                            <option value="1">1 знак (0.1)</option>
                            <option value="2">2 знака (0.01)</option>
                            <option value="3">3 знака (0.001)</option>
                            <option value="4" selected>4 знака (0.0001)</option>
                            <option value="5">5 знаков (0.00001)</option>
                            <option value="6">6 знаков (0.000001)</option>
                            <option value="7">7 знаков (0.0000001)</option>
                            <option value="8">8 знаков (0.00000001)</option>
                            <option value="custom">Указать вручную</option>
                        </select>
                    </div>

                    <div id="customDecimalsGroup" class="input-group" style="display: none;">
                        <label for="customDecimals">Количество знаков после запятой (1-8)</label>
                        <input type="number" id="customDecimals" min="1" max="8" value="4">
                    </div>

                    <div class="input-group">
                        <label for="entryPrice">Цена входа (USDT)</label>
                        <input type="text" id="entryPrice" inputmode="decimal" placeholder="Введите цену входа">
                        <div class="decimals-info" id="decimalsInfo">Автоматически определено: 4 знака после запятой</div>
                    </div>

                    <div class="input-group">
                        <label for="leverage">Кредитное плечо</label>
                        <div class="leverage-container">
                            <input type="range" id="leverage" min="1" max="100" value="10">
                            <span class="leverage-value" id="leverageValue">10x</span>
                        </div>
                        <div class="leverage-warning" id="leverageWarning">
                            Высокое плечо увеличивает риск ликвидации!
                        </div>
                    </div>

                    <!-- Переключатель способа ввода стоп-лосса -->
                    <div class="stop-method-selector">
                        <button class="stop-method-btn active" data-method="atr">По ATR</button>
                        <button class="stop-method-btn" data-method="price">По цене</button>
                        <button class="stop-method-btn" data-method="percent">По проценту</button>
                    </div>

                    <!-- Группа ввода по ATR -->
                    <div class="stop-input-group active" id="atr-group">
                        <div class="input-group">
                            <label for="atr">ATR (USDT)</label>
                            <input type="number" id="atr" min="0" step="0.00000001" placeholder="Введите значение ATR">
                            <div class="preview-value">
                                Размер ATR: <span id="atrValue">0.0000 USDT</span>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="riskPercent">Риск стоп-лосс (% от ATR)</label>
                            <div class="slider-container">
                                <input type="range" id="riskPercent" min="1" max="100" value="10">
                                <span class="slider-value" id="riskPercentValue">10</span>%
                            </div>
                            <div class="preview-value">
                                Стоп-лосс: минус <span id="previewAtrPercent">0.0000 USDT</span> (<span id="previewAtrPercentValue">10%</span> от ATR)
                            </div>
                        </div>
                    </div>

                    <!-- Группа ввода по цене -->
                    <div class="stop-input-group" id="price-group">
                        <div class="input-group">
                            <label for="stopLossPrice">Цена стоп-лосса (USDT)</label>
                            <input type="number" id="stopLossPrice" min="0" step="0.00000001" placeholder="Введите цену стоп-лосса">
                            <div class="preview-value">
                                Разница: <span id="priceDifference">0.0000 USDT</span>
                            </div>
                        </div>
                    </div>

                    <!-- Группа ввода по проценту -->
                    <div class="stop-input-group" id="percent-group">
                        <div class="input-group">
                            <label for="stopLossPercent">Процент стоп-лосса (%)</label>
                            <div class="slider-container">
                                <input type="range" id="stopLossPercent" min="0.1" max="20" step="0.1" value="2">
                                <span class="slider-value" id="stopLossPercentValue">2</span>%
                            </div>
                            <div class="preview-value">
                                Стоп-лосс: <span id="previewPercentValue">0.0000 USDT</span> (<span id="previewPercent">2%</span> от цены входа)
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="riskAmount">Риск на сделку (USDT)</label>
                        <input type="number" id="riskAmount" min="0" step="0.1" value="10.0">
                    </div>

                    <div class="input-group">
                        <label for="rewardRatio1">Соотношение тейк-профита (1:X)</label>
                        <div class="slider-container">
                            <input type="range" id="rewardRatio1" min="1" max="20" value="3">
                            <span class="slider-value" id="rewardRatio1Value">3</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="rewardRatio2">Дополнительный тейк-профит (1:X)</label>
                        <div class="slider-container">
                            <input type="range" id="rewardRatio2" min="1" max="20" value="5">
                            <span class="slider-value" id="rewardRatio2Value">5</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="exchangeFee">Комиссия биржи (%)</label>
                        <input type="number" id="exchangeFee" min="0" max="1" step="0.0001" value="0.0500">
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Результаты</div>

                    <div class="result-item">
                        <span>Цена входа:</span>
                        <span class="result-value" id="entryPriceResult">0.0000 USDT</span>
                    </div>

                    <div class="result-item">
                        <span>Размер позиции:</span>
                        <span class="result-value" id="positionSize">0.0</span>
                    </div>

                    <div class="result-item">
                        <span>Стоп-лосс:</span>
                        <span class="result-value loss" id="stopLoss">0.0000 USDT <span class="percentage-value" id="stopLossPercent"></span><span class="loss-usdt" id="stopLossUsdt"></span></span>
                    </div>

                    <div class="result-item">
                        <span>ATR:</span>
                        <span class="result-value" id="atrResult">0.0000 USDT</span>
                    </div>
                    
                    <div class="result-item">
                        <span>Комиссия биржи:</span>
                        <span class="result-value fee-value" id="exchangeFeeResult">0.0500%</span>
                    </div>

                    <div class="take-profit-levels" id="takeProfitLevels">
                        <!-- Уровни тейк-профита будут добавлены динамически -->
                    </div>

                    <div class="result-item">
                        <span>Цена ликвидации:</span>
                        <span class="result-value loss" id="liquidationPrice">0.0000 USDT <span class="percentage-value" id="liquidationPricePercent"></span></span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button class="export-btn flex-1" id="exportTextBtn">
                        <i class="fas fa-file-alt mr-2"></i>Экспорт в текст
                    </button>
                    <button class="export-btn flex-1" id="exportTelegramBtn">
                        <i class="fab fa-telegram mr-2"></i>Отправить в Telegram
                    </button>
                    <button class="export-btn flex-1" id="copyCalculationBtn">
                        <i class="fas fa-copy mr-2"></i>Копировать расчет
                    </button>
                </div>
            </div>

            <!-- Предпосылки (правая колонка) -->
            <div class="premises-container">
                <h1>Предпосылки</h1>

                <div class="button-container">
                    <button onclick="toggleText('breakthrough')">Пробой</button>
                    <button onclick="toggleText('falseBreakthrough')">Ложный пробой</button>
                    <button style="background-color: #C62828;" onclick="toggleText('breakthroughMinuses')">Пробой минусы</button>
                    <button style="background-color: #C62828;" onclick="toggleText('falseBreakthroughMinuses')">Ложный пробой минусы</button>
                    <button style="background-color: #757575;" onclick="toggleTvhButtons('tvhBreakthrough')">ТВХ пробой</button>
                    <button style="background-color: #757575;" onclick="toggleTvhButtons('tvhFalseBreakthrough')">ТВХ ложный пробой</button>
                    <button style="background-color: #4CAF50;" onclick="toggleAlgorithmButtons()">Алгоритм</button>
                </div>

                <div id="tvhBreakthroughButtons" class="tvh-sub-buttons">
                    <button onclick="showTvhText('tvhPrimaryMovement')">ТВХ №1 Первичное движение</button>
                    <button onclick="showTvhText('tvhTradingAbove')">ТВХ №2 После проторговки возле уровня</button>
                    <button onclick="showTvhText('tvhTradingBelow')">ТВХ №3 Проторговка после пробоя</button>
                    <button onclick="showTvhText('tvhSecondaryMovement')">ТВХ №4 во вторичное движение</button>
                    <button onclick="showTvhText('tvhEntry')">ТВХ №5  После ретеста </button>
                </div>

                <div id="tvhFalseBreakthroughButtons" class="tvh-sub-buttons">
                    <button onclick="showTvhText('tvhFalsePrimaryMovement')">ТВХ первичное движение</button>
                    <button onclick="showTvhText('tvhFalseTradingAbove')">ТВХ проторговки над уровнем</button>
                    <button onclick="showTvhText('tvhFalseTradingBelow')">ТВХ проторговки под уровнем</button>
                    <button onclick="showTvhText('tvhFalseSecondaryMovement')">ТВХ во вторичное движение</button>
                    <button onclick="showTvhText('tvhFalseEntry')">ТВХ вход</button>
                </div>

                <div id="algorithmButtons" class="algorithm-sub-buttons">
                    <button onclick="showTvhText('algorithmPremises')">Отбор по дневки </button>
                    <button onclick="toggleAlgorithmSubButtons('falseBreakthroughAlgorithm')">Ложный пробой</button>
                    <button onclick="toggleAlgorithmSubButtons('breakthroughAlgorithm')">Пробой</button>
					<button onclick="showTvhText('algorithmUFormation')">U-Формация</button>
                    <button onclick="showTvhText('algorithmVFormation')">V-Формация</button>
                    <button onclick="showTvhText('algorithmChannel')">Каннал</button>
                    <button onclick="showTvhText('algorithmTailedBar')">Бар с хвостами</button>
                    <button onclick="showTvhText('algorithmBarClosing')">Закрытие баров</button>
                    <button onclick="showTvhText('algorithmTradingLevels')">Уровни которые я торгую</button>
                    <button onclick="showTvhText('algorithmBreakthroughModels')">Пробойные модели</button>
                </div>

                <!-- Дополнительные кнопки для алгоритма ложного пробоя -->
                <div id="falseBreakthroughAlgorithmButtons" class="algorithm-sub-buttons" style="display: none;">
                    <button class="back-button" onclick="backToAlgorithmMain()">
                        <i class="fas fa-arrow-left"></i> Назад к алгоритму
                    </button>
                    <button onclick="showTvhText('algorithmNoRetracement')">Безоткатное движение</button>
                    <button onclick="showTvhText('algorithmParanormalBars')">Подход на паранормальных барах</button>
                    <button onclick="showTvhText('algorithmDistribution')">Дистрибуция</button>
                    <button onclick="showTvhText('algorithmFarClosing')">Дальнее закрытие от уровня</button>
                    <button onclick="showTvhText('algorithmFarRetest')">Дальный ретест</button>
                    <button onclick="showTvhText('algorithmInfectedZone')">Зона зараженности</button>
                    <button onclick="showTvhText('algorithmExtremum')">Экстремум</button>
                </div>

                <!-- Дополнительные кнопки для алгоритма пробоя -->
                <div id="breakthroughAlgorithmButtons" class="algorithm-sub-buttons" style="display: none;">
                    <button class="back-button" onclick="backToAlgorithmMain()">
                        <i class="fas fa-arrow-left"></i> Назад к алгоритму
                    </button>
                    <button onclick="showTvhText('algorithmSqueeze')">Поджатие</button>
                    <button onclick="showTvhText('algorithmNarrowTrading')">Узкая проторговка</button>
                    <button onclick="showTvhText('algorithmConsolidation')">Консолидация вдоль уровня с поджатием</button>
                    <button onclick="showTvhText('algorithmRange')">Рендж</button>
                    <button onclick="showTvhText('algorithmCloseToLevel')">Закрытие в близи уровня</button>
                    <button onclick="showTvhText('algorithmNearRetest')">Ближний ретест</button>
                    <button onclick="showTvhText('algorithmNoReactionToLP')">Нет реакции на ЛП</button>
                    <button onclick="showTvhText('algorithmDailyClose')">Закрытие дневки под хай /лоу После паронормального бара нет отката</button>
                </div>

                <div id="breakthroughText" class="text-display">
                    <h3>Пробой</h3>
                    <p>📊Предпосылки</p>
				    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Глобальный тренд лонг</span></div>
					<div class="checkbox-item"><input type="checkbox"><span class="item-text">Глобальный тренд шорт</span></div>
					<div class="checkbox-item"><input type="checkbox"><span class="item-text">Локальный тренд лонг</span></div>
					<div class="checkbox-item"><input type="checkbox"><span class="item-text">Локальный тренд шорт</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Ближний ретест</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Нет реакции на ЛП</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Накопление</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Закрытие вблизи уровня до (5%)</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">После сильного движения нет отката</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Впереди свободная зона</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Выкупной бар</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Продажный бар</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Проторговка вблизи уровня на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Проторговка вблизи уровня на коротком таймфрейме 1ч/4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Подходит поджатием на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Подходит поджатием на 1ч/4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Понижающие хаи и лои на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Понижающие хаи и лои на лок.ТФ 1ч/4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Повышающие хаи и лои 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Повышающие хаи и лои на лок.ТФ 1ч/4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Затухание волатильности на 1d</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Затухание волатильности на лок.ТФ 1ч/4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Уровень находится на круглом числе</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Задерг против тренда</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Слабея рынка</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Сильнее рынка</span></div>
                </div>

                <div id="falseBreakthroughText" class="text-display">
                    <h3>Ложный пробой</h3>
                    <p>📊Предпосылки</p>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Дальний ретест (от 10 дней)</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Подход на больших барах</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Резкий подход на лок таймфрейме</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Выход повышенные объемы перед уровням на 1ч 4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Экстремум</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Впереди зараженная зона</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Длинное безоткатное движение</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Закрытие вдали от уровня мин от 10%(больше половины от ATR)</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Нет накопления</span></div>
                     <div class="checkbox-item"><input type="checkbox"><span class="item-text">Сильный уровень впереди</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text"> V подход к уровню(без накопления) </span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Дистрибуция</span></div>
                   <div class="checkbox-item"><input type="checkbox"><span class="item-text">Повышенная волатильность</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Нет ипульса после пробоя</span></div>
                    
                </div>

                <div id="breakthroughMinusesText" class="text-display">
                    <h3>Пробой минусы</h3>
                    <p>⛔️ Минусы</p>
					<div class="checkbox-item"><input type="checkbox"><span class="item-text">Глобальный и локальный тренд не совпадают</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Повышенная волатильность на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Повышенная волатильность на лок.ТФ 1ч/4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Зараженная зона на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Зараженная зона на лок.ТФ</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Глубокий ЛП</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Резкий подход на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Резкий подход на лок ТФ</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Далеко закрылись от уровня</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Пройдено больше половина ATR</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Накопление на 1ч далеко от уровня</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Выравнивание баров на 1D </span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Выравнивание баров на лок.ТФ</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Выход повышенного объёма на лок.ТФ</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Слабое накопление на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Слабое накопление на лок.ТФ</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Уровень часто прошивается на лок.ТФ</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Длиное безоткатное движение к уровню</span></div>
                   
                </div>

                <div id="falseBreakthroughMinusesText" class="text-display">
                    <h3>Ложный пробой минусы</h3>
                    <p>⛔️ Минусы</p>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Накопление на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Накопление на лок.ТФ 1-4ч</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">В переди свободная зона</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Глубокий пробой</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Закрытие вблизи уровня на 1D</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Поджатие с затуханиям волатильности</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Поступательное движения к уровню</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Накопление в близи уровня</span></div>
                    <div class="checkbox-item"><input type="checkbox"><span class="item-text">Большой запас ATR</span></div>
                </div>

                <div id="actionButtons" class="action-buttons-container">
                    <button id="copyBtn" class="action-btn" onclick="copySelectedText()">Копировать текст</button>
                    <button id="exportBtn" class="action-btn export-btn-premises" onclick="exportSelectedToTelegram()">Отправить в Telegram</button>
                    <button id="resetBtn" class="action-btn reset-btn" onclick="resetCheckboxes()">Сбросить все</button>
                </div>

                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
    </div>

    <!-- Оверлей и контейнер для ТВХ текста -->
    <div class="overlay" id="tvhOverlay"></div>
    <div class="tvh-text-content" id="tvhTextContent">
        <button class="tvh-text-close" onclick="closeTvhText()">&times;</button>
        <div class="tvh-content" id="tvhTextInner"></div>
        <button class="tvh-copy-btn" onclick="copyTvhText()">
            <i class="fas fa-copy"></i> Копировать
        </button>
    </div>

    <!-- Модальное окно для фото -->
    <div class="photo-modal" id="photoModal">
        <button class="photo-close" onclick="closePhotoModal()">&times;</button>
        <button class="fullscreen-btn" onclick="toggleFullscreen()">
            <i class="fas fa-expand" id="fullscreenIcon"></i>
        </button>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomOut()">-</button>
            <button class="zoom-btn zoom-reset-btn" onclick="resetZoom()">1:1</button>
            <button class="zoom-btn" onclick="zoomIn()">+</button>
        </div>
        <div class="photo-container" id="photoContainer">
            <div class="photo-image-container">
                <img class="photo-image-fit" id="photoImage" src="" alt="ТВХ изображение">
            </div>
        </div>
        <div class="photo-thumbnails" id="photoThumbnails"></div>
        <div class="photo-navigation">
            <button class="nav-btn" id="prevPhotoBtn" onclick="changePhoto(-1)">
                <i class="fas fa-chevron-left"></i> Предыдущее
            </button>
            <div class="photo-counter" id="photoCounter">1 / 1</div>
            <button class="nav-btn" id="nextPhotoBtn" onclick="changePhoto(1)">
                Следующее <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed top-0 left-0 right-0 bottom-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-dark rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-primary">Вход в аккаунт</h3>
                <button onclick="closeLoginModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="input-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Ваш email">
                </div>
                <div class="input-group">
                    <label for="loginPassword">Пароль</label>
                    <input type="password" id="loginPassword" placeholder="Ваш пароль">
                </div>
                <button onclick="handleLogin()" class="btn-primary w-full text-white py-2 px-4 rounded-md font-medium mt-4">
                    Войти
                </button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="fixed top-0 left-0 right-0 bottom-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-dark rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-primary">Регистрация</h3>
                <button onclick="closeRegisterModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="input-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="Ваш email">
                </div>
                <div class="input-group">
                    <label for="registerPassword">Пароль</label>
                    <input type="password" id="registerPassword" placeholder="Придумайте пароль">
                </div>
                <div class="input-group">
                    <label for="registerConfirmPassword">Подтвердите пароль</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Повторите пароль">
                </div>
                <button onclick="handleRegister()" class="btn-primary w-full text-white py-2 px-4 rounded-md font-medium mt-4">
                    Зарегистрироваться
                </button>
            </div>
        </div>
    </div>

    <!-- Telegram Settings Modal -->
    <div id="telegramSettingsModal" class="export-modal">
        <div class="export-modal-content">
            <div class="export-modal-header">
                <div class="export-modal-title">Настройки Telegram</div>
                <button class="export-modal-close" onclick="closeTelegramSettingsModal()">&times;</button>
            </div>
            <div class="export-modal-body">
                <p>Для отправки сообщений в Telegram укажите данные вашего бота:</p>

                <div class="telegram-settings-form">
                    <label for="telegramBotToken">Токен бота</label>
                    <input type="text" id="telegramBotToken" placeholder="123456789:ABCdefGHIJKlmNoPQRsTUVwxyZ">

                    <label for="telegramChatId">ID чата</label>
                    <input type="text" id="telegramChatId" placeholder="1720793889">

                    <button onclick="saveTelegramSettings()">Сохранить настройки</button>
                    <button class="telegram-test-btn" onclick="testTelegramConnection()">Проверить соединение</button>
                </div>
            </div>
            <div class="export-modal-footer">
                <button class="export-modal-btn export-modal-btn-close" onclick="closeTelegramSettingsModal()">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let isLong = true;
        let stopMethod = 'atr';
        let tradeType = 'long-breakout';
        const botToken = '8044055704:AAGk8cQFayPqYCscLlEB3qGRj0Uw_NTpe30';
        const chatId = '1720793889';
        let isTradeTypeSelectorVisible = false;
        let currentPhotoIndex = 0;
        let currentPhotos = [];
        let currentScale = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        let isFullscreen = false;
        let minScale = 1;
        let currentAlgorithmType = null;

        // Полная база ТВХ текстов с фото
        const tvhTexts = {
            tvhPrimaryMovement: {
                text: `
                    <h3>ТВХ №1 Первичное движение</h3>
                    <p>Первичное движение-Часовые бары при подходе к уровню должны быть не большимими  одного цвета хотябы 3-4 последних бара перед уровнем закрытие должно быть в близи уровня .
                       5 минут бары должны  поодходить поджатием и не высокая волатильность.
                       Также подход на часовеке и на 5м должен быть плавным на низкой волатильности (все предпосылки к пробо.)
                       Также усиливыющие факторы закрытие дневки прям перед уровнем.
                       В переди свободная зона, нет заколов.
                       Если все условия соблюдены можно ставить стоп 5% от ATR.</p>
                    
                    <p>Условия перезахода<br>
                    1) Картинка не поломалась.<br>
                    2) Уровень не пилится.<br>
                    3) Нет глубокого отката.<br>
                    4) Пониженная волатильность.<br>
                    Больше 2-х раза не перезахожу.</p>
                    
                    <div class="photo-section">
                        <div class="photo-section-title">Примеры Лонг</div>
                        <div class="photo-gallery">
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/QNT%201H%20102.44%20proboy%20long.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/QNT%201H%20102.44%20proboy%20long.png?raw=true', 'https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/ETH%201H%20%20long%20proboy%202610.72.png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/QNT%201H%20102.44%20proboy%20long.png?raw=true" alt="QNT 1H">
                                <div class="photo-gallery-caption">QNT 1H</div>
                            </div>
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/ETH%201H%20%20long%20proboy%202610.72.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/QNT%201H%20102.44%20proboy%20long.png?raw=true', 'https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/ETH%201H%20%20long%20proboy%202610.72.png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/ETH%201H%20%20long%20proboy%202610.72.png?raw=true" alt="ETH 1H">
                                <div class="photo-gallery-caption">ETH 1H</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="photo-section">
                        <div class="photo-section-title">Примеры Шорт</div>
                        <div class="photo-gallery">
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/1000000BOBUSDT%20%200.04944%201h%20proboy%20short%20(1).png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/1000000BOBUSDT%20%200.04944%201h%20proboy%20short%20(1).png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/1000000BOBUSDT%20%200.04944%201h%20proboy%20short%20(1).png?raw=true" alt="BOBUSDT 1H">
                                <div class="photo-gallery-caption">BOBUSDT 1H</div>
                            </div>
                        </div>
                    </div>
                `
            },
            tvhTradingAbove: {
                text: `
                   <h3>ТВХ №2 После проторговки возле уровня</h3>
                   <p>На 1 час должен закрыться в близи уровня или может сделать ЛП и не откатывать,
                      на 5 мин начинается проторговка с низкой волатильностью(все предпосылки к пробо.)</p>
                    <p>Условия перезахода<br>
                    1) Картинка не поломалась.<br>
                    2) Уровень не пилится.<br>
                    3) Нет глубокого отката.<br>
                    4) Пониженная волатильность.<br>
                    Больше 2-х раза не перезахожу.</p>
                    
                    <div class="photo-section">
                        <div class="photo-section-title">Примеры Лонг</div>
                        <div class="photo-gallery">
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B8%20%D0%B2%D0%BE%D0%B7%D0%BB%D0%B5%20%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F/ZKUSDT%200.03101%201h%20%20proboy%20LONG.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B8%20%D0%B2%D0%BE%D0%B7%D0%BB%D0%B5%20%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F/ZKUSDT%200.03101%201h%20%20proboy%20LONG.png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B8%20%D0%B2%D0%BE%D0%B7%D0%BB%D0%B5%20%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F/ZKUSDT%200.03101%201h%20%20proboy%20LONG.png?raw=true" alt="ZKUSDT">
                                <div class="photo-gallery-caption">ZKUSDT</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="photo-section">
                        <div class="photo-section-title">Примеры Шорт</div>
                        <div class="photo-gallery">
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B8%20%D0%B2%D0%BE%D0%B7%D0%BB%D0%B5%20%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F/LAUSDT%201h%20%200.988%20proboy%20short.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B8%20%D0%B2%D0%BE%D0%B7%D0%BB%D0%B5%20%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F/LAUSDT%201h%20%200.988%20proboy%20short.png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B8%20%D0%B2%D0%BE%D0%B7%D0%BB%D0%B5%20%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F/LAUSDT%201h%20%200.988%20proboy%20short.png?raw=true" alt="LAUSDT">
                                <div class="photo-gallery-caption">LAUSDT</div>
                            </div>
                        </div>
                    </div>
                `
            },
            tvhTradingBelow: {
                text: `
                    <h3>ТВХ №3 Проторговка после пробоя</h3>
                    <p>На часавике бар пробил и закрылся далеко от уровня.
                       на 5 минутки  должен оброзоватся локальный уровень БСУ БПУ1 БПУ2 стоп ставить за дневной уровень.
                       Также подход на часовеке и на 5м должен быть плавным на низкой волатильности (все предпосылки к пробо.).<br>
                   </p>
                    <p>Условия перезахода<br>
                    1) Картинка не поломалась.<br>
                    2) Уровень не пилится<br>
                    3) Нет глубокого отката.<br>
                    4) Пониженная волатильности.<br>
                    Больше 2-х раза не перезахожу</p>
                    
                    <div class="photo-section">
                        <div class="photo-section-title">Примеры Лонг</div>
                        <div class="photo-gallery">
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D0%B1%D0%BE%D1%8F/MUSDT%200.4729%201h%20proboy%20LONG.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D0%B1%D0%BE%D1%8F/MUSDT%200.4729%201h%20proboy%20LONG.png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D1%80%D0%BE%D1%82%D0%BE%D1%80%D0%B3%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%20%D0%BF%D1%80%D0%BE%D0%B1%D0%BE%D1%8F/MUSDT%200.4729%201h%20proboy%20LONG.png?raw=true" alt="MUSDT">
                                <div class="photo-gallery-caption">MUSDT</div>
                            </div>
                        </div>
                    </div>
                `
            },
            tvhSecondaryMovement: {
                text: `
                    <h3>ТВХ №4 Во вторичное движение</h3>
                    <p>1 час подлетел из далека делает лп и делает не клубокий отскок не больше 30% от ATR. Возрат через 2-4 часовых бара или V образно.
                        на 5 минутки должно быть закругление.<br>
                    Стоп ставлю расчетный.</p>
                    <p>Условия перезахода<br>
                    1) Картинка не поломалась.<br>
                    2) Уровень не пилится<br>
                    3) Нет глубокого отката.<br>
                    4) Пониженная волатильности.<br>
                    Больше 2-х раза не перезахожу</p>
                    
                    <div class="photo-section">
                        <div class="photo-section-title">Примеры Лонг</div>
                        <div class="photo-gallery">
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D1%87%D0%BD%D0%BE%D0%B5/TRXUSDT%200,33485%201h%20proboy%20LONG.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D1%87%D0%BD%D0%BE%D0%B5/TRXUSDT%200,33485%201h%20proboy%20LONG.png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D1%87%D0%BD%D0%BE%D0%B5/TRXUSDT%200,33485%201h%20proboy%20LONG.png?raw=true" alt="TRXUSDT">
                                <div class="photo-gallery-caption">TRXUSDT</div>
                            </div>
                        </div>
                    </div>
                `
            },
            tvhEntry: {
                text: `
                    <h3>ТВХ №5 После ретеста</h3>
                    <p>Часовой бар закрывается под уровнем (или над) не далеко.На 5 мин возвращение к уровню и должен произойти ЛП,
                       твх на после возвращением за уровень втором красном баре при шорте и на втором зеленом при лонг.
                       Также подход на часовеке и на 5м должен быть плавным на низкой волатильности (все предпосылки к пробо.) </p>
                    <p>Условия перезахода<br>
                    1) Картинка не поломалась.<br>
                    2) Уровень не пилится<br>
                    3) Нет глубокого отката.<br>
                    4) Пониженная волатильности.<br>
                    Больше 2-х раза не перезахожу</p>
                    
                    <div class="photo-section">
                        <div class="photo-section-title">Примеры Лонг</div>
                        <div class="photo-gallery">
                            <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D1%80%D0%B5%D1%82%D0%B5%D1%81%D1%82%D0%B0/UMAUSDT%201h%201.412%20%20proboy%20long.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D1%80%D0%B5%D1%82%D0%B5%D1%81%D1%82%D0%B0/UMAUSDT%201h%201.412%20%20proboy%20long.png?raw=true'])">
                                <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%9F%D0%BE%D1%81%D0%BB%D0%B5%20%D1%80%D0%B5%D1%82%D0%B5%D1%81%D1%82%D0%B0/UMAUSDT%201h%201.412%20%20proboy%20long.png?raw=true" alt="UMAUSDT">
                                <div class="photo-gallery-caption">UMAUSDT</div>
                            </div>
                        </div>
                    </div>
                `
            },
            // Добавляем остальные ТВХ тексты
            tvhFalsePrimaryMovement: { 
                text: "<h3>ТВХ ложного пробоя - Первичное движение</h3><p>Текст будет добавлен...</p>",
                photos: { long: [], short: [] }
            },
            tvhFalseTradingAbove: { 
                text: "<h3>ТВХ ложного пробоя - Проторговки над уровнем</h3><p>Текст будет добавлен...</p>",
                photos: { long: [], short: [] }
            },
            tvhFalseTradingBelow: { 
                text: "<h3>ТВХ ложного пробоя - Проторговки под уровнем</h3><p>Текст будет добавлен...</p>",
                photos: { long: [], short: [] }
            },
            tvhFalseSecondaryMovement: { 
                text: "<h3>ТВХ ложного пробоя - Вторичное движение</h3><p>Текст будет добавлен...</p>",
                photos: { long: [], short: [] }
            },
            tvhFalseEntry: { 
                text: "<h3>ТВХ ложного пробоя - Вход</h3><p>Текст будет добавлен...</p>",
                photos: { long: [], short: [] }
            },

            // Алгоритмы
            algorithmPremises: {
                 text: `
        <h3>Алгоритм - для отбора инструментов по дневке</h3>

        <h3>Пробой</h3>
        <ol>
            <li>1. Сильный дневной уровень(или 12 часов)</li>
            <li>2. Закрытие дневного бара вблизи уровня</li>
            <li>3. Нет Зараженной зона впереди (впереди пустота)Если заражения зона больше двух недель она не актуальна</li>
            <li>4. Уровень не должен быть запилен.</li>
            <li>5. Накопление</li>
            <li>6. Как подошли к уровню?(на паранормальных барах или с поджатием)</li>
            <li>7. Сколько прошли?(чем больше прошли тем больше шансы что инструмент развернется)</li>
            <li>8. Как прошли?(было движенье безоткатное или было с откатами)</li>
            <li>9. Откуда пришли?(развернулся инструмент воздухе или было накопление)</li>
        </ol>
       
        <h3>Ложный пробой</h3>
        <ol>				 
            <li>1. Сильный дневной уровень(или 12 часов)</li>
            <li>2. Закрытие дневного бара вблизи уровня</li>
            <li>3. Нет Зараженной зона впереди (впереди пустота)Если заражения зона больше двух недель она не актуальна</li>
            <li>4. Уровень не должен быть запилен.</li>
            <li>5. Накопление</li>
            <li>6. Как подошли к уровню?(на паранормальных барах или с поджатием)</li>
            <li>7. Сколько прошли?(чем больше прошли тем больше шансы что инструмент развернется)</li>
            <li>8. Как прошли?(было движенье безоткатное или было с откатами)</li>
            <li>9. Откуда пришли?(развернулся инструмент воздухе или было накопление)</li>
        </ol>
       
        <div class="photo-section">
            <div class="photo-section-title">Уровни которые я торгую</div>
            <div class="photo-gallery">
                <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%A3%D1%80%D0%BE%D0%B2%D0%BD%D0%B8%20%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D1%8B%D0%B5%20%D1%8F%20%D1%82%D0%BE%D1%80%D0%B3%D1%83%D1%8E.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%A3%D1%80%D0%BE%D0%B2%D0%BD%D0%B8%20%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D1%8B%D0%B5%20%D1%8F%20%D1%82%D0%BE%D1%80%D0%B3%D1%83%D1%8E.png?raw=true'])">
                    <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%A3%D1%80%D0%BE%D0%B2%D0%BD%D0%B8%20%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D1%8B%D0%B5%20%D1%8F%20%D1%82%D0%BE%D1%80%D0%B3%D1%83%D1%8E.png?raw=true" alt="Уровни которые я торгую">
                    <div class="photo-gallery-caption">Уровни которые я торгую</div>
                </div>
            </div>
        </div>
    `
},

            // Все остальные алгоритмы с одинаковой структурой
            algorithmNoRetracement: {
                text: `
                    <h3>Алгоритм - Безоткатное движение</h3>
                    <p>Длинное безоткатное движение это когда инструмент прошел много и шел долго и без отката (50% и больше)скорей всего инструмент начнет откатываться у ближайший сильных дневных уровней, такое движение ведет к отбою или ложному пробою.при длинном безоткатном движение в инструменте накопилась контр трендовая энергия.</p>
                    
                   <div class="photo-section">
    <div class="photo-section-title">Безоткатное движение</div>
    <div class="photo-gallery">
        <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%91%D0%B5%D0%B7%D0%BE%D1%82%D0%BA%D0%B0%D1%82%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%91%D0%B5%D0%B7%D0%BE%D1%82%D0%BA%D0%B0%D1%82%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F.png?raw=true'])">
            <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%91%D0%B5%D0%B7%D0%BE%D1%82%D0%BA%D0%B0%D1%82%D0%BD%D0%BE%D0%B5%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F.png?raw=true" alt="Описание вашего фото">
            <div class="photo-gallery-caption">Безоткатное движение</div>
        </div>
    </div>
</div>
                `
            },

            algorithmParanormalBars: {
                text: `
                    <h3>Алгоритм - Подход на паранормальных барах</h3>
                    <p>Это означает что скорее всего нет большого сопротивления. Малая плотность лимитных
ордеров. И скорее всего самое большое сопротивление будет уже на уровне. Но если
инструмент очень сильно прошел и закрылся под самый хай, то мы ожидаем все равно
пробоя, но смотрим глубину этого пробоя. При отсутствии импульса глубина пробоя
маленькая и значит будет ложный пробой.(нужно учитывать и короткий тайм-фрейм)
Но! Если на коротком тайм-фрейме внутри большого дневного бара идет маленькое
поступательное движение на коротких барах, это скорее всего приведет к пробою.</p>
                    
                   <div class="photo-section">
    <div class="photo-section-title">Подход на паранормальных барах</div>
    <div class="photo-gallery">
        <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%9F%D0%BE%D0%B4%D1%85%D0%BE%D0%B4%20%D0%BD%D0%B0%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D0%B1%D0%B0%D1%80%D0%B0%D1%85.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%9F%D0%BE%D0%B4%D1%85%D0%BE%D0%B4%20%D0%BD%D0%B0%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D0%B1%D0%B0%D1%80%D0%B0%D1%85.png?raw=true'])">
            <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%9F%D0%BE%D0%B4%D1%85%D0%BE%D0%B4%20%D0%BD%D0%B0%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D0%B1%D0%B0%D1%80%D0%B0%D1%85.png?raw=true" alt="Описание вашего фото">
            <div class="photo-gallery-caption">Подход на паранормальных барах</div>
        </div>
    </div>
</div>
                `
            },

            // Остальные алгоритмы с аналогичной структурой...
            algorithmDistribution: { 
                text: `
                    <h3>Алгоритм - Дистрибуция</h3>
                    <p>На дневки это выглядит в виде больших баров. Но если вдруг на коротком тайм-фрейме
внутри большого дневного бара идет маленькое поступательное движение на коротких
барах, это скорее всего приведет к пробою.Дистрибуция ведет к развороту либо 
к остановке.</p>
<div class="photo-section">
    <div class="photo-section-title">Дистрибуция</div>
    <div class="photo-gallery">
        <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D1%8F%20%D0%BD%D0%B0%20%D1%81%D1%82%D0%B0%D1%80%D1%88%D0%BE%D0%BC%20%D1%82%D0%B0%D0%B9%D0%BC%D0%B5.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D1%8F%20%D0%BD%D0%B0%20%D1%81%D1%82%D0%B0%D1%80%D1%88%D0%BE%D0%BC%20%D1%82%D0%B0%D0%B9%D0%BC%D0%B5.png?raw=true'])">
            <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D1%8F%20%D0%BD%D0%B0%20%D1%81%D1%82%D0%B0%D1%80%D1%88%D0%BE%D0%BC%20%D1%82%D0%B0%D0%B9%D0%BC%D0%B5.png?raw=true" alt="Описание вашего фото">
            <div class="photo-gallery-caption">Дистрибуция</div>
        </div>
    </div>
</div>
                `
            },

            algorithmFarClosing: { 
                text: `
                    <h3>Алгоритм - Дальнее закрытие от уровня</h3>
                    <p>Инструмент подошел к уровню, но закрывается далеко от него. 
Есть сильное сопротивление, и следовательно возрастает вероятность разворота.</p>
                   <div class="photo-section">
    <div class="photo-section-title">Дальнее закрытие от уровня</div>
    <div class="photo-gallery">
        <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B0%D0%BB%D1%8C%D0%BD%D0%B5%D0%B5%20%D0%B7%D0%B0%D0%BA%D1%80%D1%8B%D1%82%D0%B8%D0%B5.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B0%D0%BB%D1%8C%D0%BD%D0%B5%D0%B5%20%D0%B7%D0%B0%D0%BA%D1%80%D1%8B%D1%82%D0%B8%D0%B5.png?raw=true'])">
            <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B0%D0%BB%D1%8C%D0%BD%D0%B5%D0%B5%20%D0%B7%D0%B0%D0%BA%D1%80%D1%8B%D1%82%D0%B8%D0%B5.png?raw=true" alt="Описание вашего фото">
            <div class="photo-gallery-caption">Дальнее закрытие от уровня</div>
        </div>
    </div>
</div>
                `
            },

            // Добавляем остальные алгоритмы с аналогичной структурой
            algorithmFarRetest: { 
                text:` 
					"<h3>Алгоритм - Дальный ретест</h3>
					 <p>Дальний ретест от 2 недель - 1 месяца до 1 года в 90% случаях с первого раза не пробивается будет отбой или ложный пробой.
Что усиливает дальний ретест; 
1)Если инструмент много проходит без остановки
2)Если инструмент подходит к уровню на паранормальных барах(если последний бар перед уровнем паронормальный 90% будет отбой или ложный пробой)
В каких случаях это правило отменяется; если подход был на паранормальных барах а перед уровнем инструмент замедляется и подходит на маленьких барах, и закрывается под самый уровень.</p>
					<div class="photo-section">
    <div class="photo-section-title">Дальный ретест</div>
    <div class="photo-gallery">
        <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B0%D0%BB%D1%8C%D0%BD%D0%BD%D0%B8%D0%B9%20%D1%80%D0%B5%D1%82%D0%B5%D1%81%D1%82.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B0%D0%BB%D1%8C%D0%BD%D0%BD%D0%B8%D0%B9%20%D1%80%D0%B5%D1%82%D0%B5%D1%81%D1%82.png?raw=true'])">
            <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B4%D0%B0%D0%BB%D1%8C%D0%BD%D0%BD%D0%B8%D0%B9%20%D1%80%D0%B5%D1%82%D0%B5%D1%81%D1%82.png?raw=true" alt="Описание вашего фото">
            <div class="photo-gallery-caption">Дальный ретест</div>
        </div>
    </div>
</div>
                `
            },
            algorithmInfectedZone: { 
               text: `
                    <h3>Алгоритм - Зона Заражённости</h3>
                    <p>Зона заражённости это когда инструмент попадает в одну из зон где была проторговка инструменту тяжело проходить такие зоны, зона заражённости скорей всего будет служить 
Поддержкой или сопротивлением и скорей всего это будет остановка отбой или ложный пробой.с первого раза инструмент такую зону не пройдет, нужно чтоб эту зону прочистили ,прочистить такую зону может один бар (снимите все лимитные заявки) Если Заражённая зона больше двух недель она не актуальна</p>
             <div class="photo-section">
    <div class="photo-section-title">Зона Заражённости</div>
    <div class="photo-gallery">
        <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B7%D0%B0%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B0%D1%8F%20%D0%B7%D0%BE%D0%BD%D0%B0.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B7%D0%B0%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B0%D1%8F%20%D0%B7%D0%BE%D0%BD%D0%B0.png?raw=true'])">
            <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D0%B7%D0%B0%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B0%D1%8F%20%D0%B7%D0%BE%D0%BD%D0%B0.png?raw=true" alt="Описание вашего фото">
            <div class="photo-gallery-caption">Зона Заражённости</div>
        </div>
    </div>
</div>
			  `  
            },
            algorithmExtremum: { 
                text: ` "<h3>Алгоритм - Экстремум</h3>
					<p>Такую точку с первого раза инструменту будет сложно пройти, потому-что в таких точках будет большое количества лимитных ордеров.</p>
					<div class="photo-section">
    <div class="photo-section-title">Экстремум</div>
    <div class="photo-gallery">
        <div class="photo-gallery-item" onclick="openPhotoModal('https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D1%8D%D0%BA%D1%81%D1%82%D1%80%D0%B5%D0%BC%D1%83%D0%BC.png?raw=true', ['https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D1%8D%D0%BA%D1%81%D1%82%D1%80%D0%B5%D0%BC%D1%83%D0%BC.png?raw=true'])">
            <img src="https://github.com/donpu333/CryptoWidget/blob/main/images/%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC/%D1%8D%D0%BA%D1%81%D1%82%D1%80%D0%B5%D0%BC%D1%83%D0%BC.png?raw=true" alt="Описание вашего фото">
            <div class="photo-gallery-caption">Экстремум</div>
        </div>
    </div>
</div>
            `
            },
            algorithmSqueeze: { 
                text: "<h3>Алгоритм - Поджатие</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmNarrowTrading: { 
                text: "<h3>Алгоритм - Узкая проторговка</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmConsolidation: { 
                text: "<h3>Алгоритм - Консолидация вдоль уровня с поджатием</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmRange: { 
                text: "<h3>Алгоритм - Рендж</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmCloseToLevel: { 
                text: "<h3>Алгоритм - Закрытие в близи уровня</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmNearRetest: { 
                text: "<h3>Алгоритм - Ближний ретест</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmNoReactionToLP: { 
                text: "<h3>Алгоритм - Нет реакции на ЛП</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmDailyClose: { 
                text: "<h3>Алгоритм - Закрытие дневки под хай /лоу После паронормального бара нет отката</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmUFormation: { 
                text: "<h3>Алгоритм - U-Формация</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmVFormation: { 
                text: "<h3>Алгоритм - V-Формация</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmChannel: { 
                text: "<h3>Алгоритм - Каннал</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmTailedBar: { 
                text: "<h3>Алгоритм - Бар с хвостами</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmBarClosing: { 
                text: "<h3>Алгоритм - Закрытие баров</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmTradingLevels: { 
                text: "<h3>Алгоритм - Уровни которые я торгую</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            },
            algorithmBreakthroughModels: { 
                text: "<h3>Алгоритм - Пробойные модели</h3><p>Текст будет добавлен...</p>",
                photos: { general: [] }
            }
        };

        // Базовые функции
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#C62828';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function toggleMenu() {
            const menuContent = document.getElementById('menuContent');
            if (menuContent) {
                menuContent.classList.toggle('show');
            }
        }

        // Закрытие меню при клике вне его
        document.addEventListener('click', (event) => {
            const menuContent = document.getElementById('menuContent');
            const menuButton = document.getElementById('menuButton');
            
            if (menuContent && menuButton && 
                !menuContent.contains(event.target) && 
                !menuButton.contains(event.target)) {
                menuContent.classList.remove('show');
            }
        });

        // Функция для определения количества знаков после запятой
        function countDecimals(value) {
            if (!value || value === '' || isNaN(parseFloat(value.replace(',', '.')))) return 0;
            
            const normalizedValue = value.replace(',', '.');
            const str = normalizedValue.toString();
            if (str.indexOf('.') === -1) return 0;
            
            return str.split('.')[1].length;
        }

        // Функция для автоматического определения точности цены
        function autoDetectPrecision(price) {
            const decimals = countDecimals(price);
            return Math.min(Math.max(decimals, 1), 8);
        }

        // Улучшенная функция для форматирования чисел с учетом типа актива
        function formatNumber(num, decimals = 8, assetType = null) {
            if (isNaN(num)) return '0';
            
            if (assetType === 'custom') {
                const customDecimals = parseInt(document.getElementById('customDecimals').value) || 4;
                const factor = Math.pow(10, customDecimals);
                const rounded = Math.round(num * factor) / factor;
                return rounded.toFixed(customDecimals);
            }
            
            if (!assetType) {
                const factor = Math.pow(10, decimals);
                const rounded = Math.round(num * factor) / factor;
                return rounded.toString().replace(/(\.\d*?[1-9])0+$/, '$1').replace(/\.$/, '');
            }
            
            const decimalPlaces = parseInt(assetType);
            const factor = Math.pow(10, decimalPlaces);
            const rounded = Math.round(num * factor) / factor;
            
            if (decimals === 1) {
                return rounded.toFixed(1);
            }
            
            if (decimals === 4 || decimals === 5 || decimals === 6 || decimals === 7 || decimals === 8) {
                return rounded.toFixed(decimalPlaces);
            }
            
            return rounded.toString().replace(/(\.\d*?[1-9])0+$/, '$1').replace(/\.$/, '');
        }

        // Функция для нормализации числа (замена запятой на точку)
        function normalizeNumber(value) {
            if (typeof value === 'string') {
                return value.replace(',', '.');
            }
            return value;
        }

        // Функция для расчета процентного изменения между двумя ценами
        function calculatePercentageChange(entryPrice, targetPrice) {
            return Math.abs((targetPrice - entryPrice) / entryPrice * 100).toFixed(2);
        }

        // Функция для генерации текста расчета
        function generateCalculationText() {
            const entryPrice = parseFloat(normalizeNumber(document.getElementById('entryPrice').value)) || 0;
            const leverage = parseFloat(document.getElementById('leverage').value) || 1;
            const atr = parseFloat(document.getElementById('atr').value) || 0;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value);
            const riskAmount = parseFloat(document.getElementById('riskAmount').value) || 0;
            const rewardRatio1 = parseFloat(document.getElementById('rewardRatio1').value) || 3;
            const rewardRatio2 = parseFloat(document.getElementById('rewardRatio2').value) || 5;
            const stopLossPriceDirect = parseFloat(normalizeNumber(document.getElementById('stopLossPrice').value)) || 0;
            const stopLossPercent = parseFloat(document.getElementById('stopLossPercent').value) || 0;
            const exchangeFee = parseFloat(document.getElementById('exchangeFee').value) || 0.0500;
            const assetType = document.getElementById('assetType').value;

            let tradeTypeName = '';
            switch(tradeType) {
                case 'long-breakout': tradeTypeName = 'Лонг Пробой'; break;
                case 'long-fakeout': tradeTypeName = 'Лонг Ложный пробой'; break;
                case 'short-breakout': tradeTypeName = 'Шорт Пробой'; break;
                case 'short-fakeout': tradeTypeName = 'Шорт Ложный пробой'; break;
            }

            let stopMethodName = '';
            switch(stopMethod) {
                case 'atr': stopMethodName = 'По ATR'; break;
                case 'price': stopMethodName = 'По цене'; break;
                case 'percent': stopMethodName = 'По проценту'; break;
            }

            let stopLossPrice, priceDifference;
            if (stopMethod === 'atr') {
                priceDifference = atr * (riskPercent / 100);
                stopLossPrice = isLong ? entryPrice - priceDifference : entryPrice + priceDifference;
            } else if (stopMethod === 'price') {
                priceDifference = Math.abs(entryPrice - stopLossPriceDirect);
                stopLossPrice = stopLossPriceDirect;
            } else if (stopMethod === 'percent') {
                priceDifference = entryPrice * (stopLossPercent / 100);
                stopLossPrice = isLong ? entryPrice - priceDifference : entryPrice + priceDifference;
            }

            const positionSize = priceDifference > 0 ? 
                riskAmount / (priceDifference * (1 + exchangeFee / 100 * 2)) : 0;

            const entryFee = entryPrice * positionSize * (exchangeFee / 100);
            
            const takeProfit1 = isLong ? 
                entryPrice + (riskAmount * rewardRatio1 + entryFee + (entryPrice * positionSize * (exchangeFee / 100))) / positionSize : 
                entryPrice - (riskAmount * rewardRatio1 + entryFee + (entryPrice * positionSize * (exchangeFee / 100))) / positionSize;
            
            const takeProfit2 = isLong ? 
                entryPrice + (riskAmount * rewardRatio2 + entryFee + (entryPrice * positionSize * (exchangeFee / 100))) / positionSize : 
                entryPrice - (riskAmount * rewardRatio2 + entryFee + (entryPrice * positionSize * (exchangeFee / 100))) / positionSize;

            const stopLossPercentValue = calculatePercentageChange(entryPrice, stopLossPrice);
            const takeProfit1Percent = calculatePercentageChange(entryPrice, takeProfit1);
            const takeProfit2Percent = calculatePercentageChange(entryPrice, takeProfit2);

            const exitFee = takeProfit2 * positionSize * (exchangeFee / 100);
            const totalFee = entryFee + exitFee;

            const text = `Дата: ${new Date().toLocaleString()}
===============================
Тип сделки: ${tradeTypeName}
Метод расчета стоп-лосса: ${stopMethodName}
Параметры сделки:
===============================
${stopMethod === 'atr' ? `ATR: ${formatNumber(atr, 8)} USDT\nРиск стоп-лосс: ${riskPercent}% от ATR` : ''}
${stopMethod === 'percent' ? `Процент стоп-лосса: ${stopLossPercent}%` : ''}
Риск на сделку: ${formatNumber(riskAmount, 1)} USDT
Соотношение тейк-профита: 1:${rewardRatio1} и 1:${rewardRatio2}
Комиссия биржи: ${exchangeFee}%
Результаты:
===============================
Цена входа: ${formatNumber(entryPrice, assetType)} USDT
Размер позиции: ${formatNumber(positionSize, 1)}
Стоп-лосс: ${formatNumber(stopLossPrice, assetType)} USDT (${stopLossPercentValue}%)
Тейк-профит 1к${rewardRatio1}: ${formatNumber(takeProfit1, assetType)} USDT (${takeProfit1Percent}%)
Тейк-профит 1к${rewardRatio2}: ${formatNumber(takeProfit2, assetType)} USDT (${takeProfit2Percent}%)
Комиссии: ${formatNumber(totalFee, 8)} USDT (вход: ${formatNumber(entryFee, 8)}, выход: ${formatNumber(exitFee, 8)})`;

            return text;
        }

        // Функция для копирования расчета в буфер обмена
        function copyCalculationToClipboard() {
            const calculationText = generateCalculationText();
            
            navigator.clipboard.writeText(calculationText).then(() => {
                showNotification('Расчет скопирован в буфер обмена!', 'success');
            }).catch(err => {
                showNotification('Не удалось скопировать расчет: ' + err, 'error');
            });
        }

        // Функция для экспорта в текстовый файл
        function exportToText() {
            const content = generateCalculationText();
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'расчет_рисков.txt';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Расчет экспортирован в файл!', 'success');
        }

        // Функция для отправки в Telegram
        async function sendToTelegram() {
            const calculationText = generateCalculationText();

            try {
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: calculationText,
                        parse_mode: 'Markdown'
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    showNotification('Расчет успешно отправлен в Telegram!', 'success');
                } else {
                    showNotification('Ошибка при отправке: ' + (data.description || 'неизвестная ошибка'), 'error');
                }
            } catch (error) {
                showNotification('Ошибка соединения: ' + error.message, 'error');
            }
        }

        // Функция для открытия фото в модальном окне
        function openPhotoModal(photoUrl, photosArray = null) {
            const modal = document.getElementById('photoModal');
            const photoImage = document.getElementById('photoImage');
            
            if (photosArray) {
                currentPhotos = photosArray;
                currentPhotoIndex = currentPhotos.indexOf(photoUrl);
                if (currentPhotoIndex === -1) {
                    currentPhotoIndex = 0;
                    currentPhotos = [photoUrl];
                }
            } else {
                currentPhotos = [photoUrl];
                currentPhotoIndex = 0;
            }
            
            photoImage.src = currentPhotos[currentPhotoIndex];
            
            resetZoom();
            
            updatePhotoCounter();
            updateNavigationButtons();
            updateThumbnails();
            
            modal.classList.add('active');
            
            addPhotoEventListeners();
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('active');
            currentScale = 1;
            translateX = 0;
            translateY = 0;
            isFullscreen = false;
            modal.classList.remove('fullscreen');
            document.getElementById('fullscreenIcon').className = 'fas fa-expand';
            
            removePhotoEventListeners();
        }

        function addPhotoEventListeners() {
            const photoImage = document.getElementById('photoImage');
            const photoContainer = document.getElementById('photoContainer');
            
            photoContainer.addEventListener('wheel', handleWheel, { passive: false });
            photoContainer.addEventListener('mousedown', startDrag);
            photoContainer.addEventListener('touchstart', startDragTouch);
            photoImage.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        function removePhotoEventListeners() {
            const photoImage = document.getElementById('photoImage');
            const photoContainer = document.getElementById('photoContainer');
            
            photoContainer.removeEventListener('wheel', handleWheel);
            photoContainer.removeEventListener('mousedown', startDrag);
            photoContainer.removeEventListener('touchstart', startDragTouch);
            photoImage.removeEventListener('contextmenu', (e) => e.preventDefault());
        }

        function handleWheel(e) {
            e.preventDefault();
            
            const delta = e.deltaY;
            const zoomIntensity = 0.1;
            
            if (delta < 0) {
                currentScale = Math.min(currentScale + zoomIntensity, 5);
            } else {
                currentScale = Math.max(currentScale - zoomIntensity, minScale);
            }
            
            updateImageTransform();
        }

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            
            const photoContainer = document.getElementById('photoContainer');
            const photoImage = document.getElementById('photoImage');
            
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            
            photoContainer.classList.add('dragging');
            photoImage.classList.add('dragging');
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function startDragTouch(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                isDragging = true;
                
                const photoContainer = document.getElementById('photoContainer');
                const photoImage = document.getElementById('photoImage');
                
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
                
                photoContainer.classList.add('dragging');
                photoImage.classList.add('dragging');
                
                document.addEventListener('touchmove', dragTouch);
                document.addEventListener('touchend', stopDrag);
            }
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            
            updateImageTransform();
        }

        function dragTouch(e) {
            if (!isDragging || e.touches.length !== 1) return;
            e.preventDefault();
            
            translateX = e.touches[0].clientX - startX;
            translateY = e.touches[0].clientY - startY;
            
            updateImageTransform();
        }

        function stopDrag() {
            isDragging = false;
            
            const photoContainer = document.getElementById('photoContainer');
            const photoImage = document.getElementById('photoImage');
            
            photoContainer.classList.remove('dragging');
            photoImage.classList.remove('dragging');
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', dragTouch);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        function updateImageTransform() {
            const photoImage = document.getElementById('photoImage');
            photoImage.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
        }

        function toggleFullscreen() {
            const modal = document.getElementById('photoModal');
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            
            isFullscreen = !isFullscreen;
            
            if (isFullscreen) {
                modal.classList.add('fullscreen');
                fullscreenIcon.className = 'fas fa-compress';
            } else {
                modal.classList.remove('fullscreen');
                fullscreenIcon.className = 'fas fa-expand';
            }
        }

        function changePhoto(direction) {
            currentPhotoIndex += direction;
            
            if (currentPhotoIndex < 0) {
                currentPhotoIndex = currentPhotos.length - 1;
            } else if (currentPhotoIndex >= currentPhotos.length) {
                currentPhotoIndex = 0;
            }
            
            const photoImage = document.getElementById('photoImage');
            photoImage.src = currentPhotos[currentPhotoIndex];
            
            resetZoom();
            
            updatePhotoCounter();
            updateNavigationButtons();
            updateThumbnails();
        }

        function selectPhoto(index) {
            currentPhotoIndex = index;
            
            const photoImage = document.getElementById('photoImage');
            photoImage.src = currentPhotos[currentPhotoIndex];
            
            resetZoom();
            
            updatePhotoCounter();
            updateNavigationButtons();
            updateThumbnails();
        }

        function updatePhotoCounter() {
            const photoCounter = document.getElementById('photoCounter');
            photoCounter.textContent = `${currentPhotoIndex + 1} / ${currentPhotos.length}`;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevPhotoBtn');
            const nextBtn = document.getElementById('nextPhotoBtn');
            
            prevBtn.disabled = currentPhotos.length <= 1;
            nextBtn.disabled = currentPhotos.length <= 1;
        }

        function updateThumbnails() {
            const thumbnailsContainer = document.getElementById('photoThumbnails');
            thumbnailsContainer.innerHTML = '';
            
            currentPhotos.forEach((photo, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.className = 'thumbnail';
                if (index === currentPhotoIndex) {
                    thumbnail.classList.add('active');
                }
                thumbnail.src = photo;
                thumbnail.alt = `Миниатюра ${index + 1}`;
                thumbnail.onclick = () => selectPhoto(index);
                thumbnailsContainer.appendChild(thumbnail);
            });
        }

        function zoomIn() {
            currentScale = Math.min(currentScale + 0.2, 5);
            updateImageTransform();
        }

        function zoomOut() {
            currentScale = Math.max(minScale, currentScale - 0.2);
            updateImageTransform();
        }

        function resetZoom() {
            currentScale = 1;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
        }

        // Закрытие модального окна фото при клике вне его
        document.addEventListener('click', (event) => {
            const modal = document.getElementById('photoModal');
            if (event.target === modal) {
                closePhotoModal();
            }
        });

        // Обработчики клавиш для навигации по фото
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('photoModal');
            if (modal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closePhotoModal();
                } else if (e.key === 'ArrowLeft') {
                    changePhoto(-1);
                } else if (e.key === 'ArrowRight') {
                    changePhoto(1);
                } else if (e.key === '+') {
                    zoomIn();
                } else if (e.key === '-') {
                    zoomOut();
                } else if (e.key === '0') {
                    resetZoom();
                }
            }
        });

        // Risk Calculator Functions
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы интерфейса
            const longBtn = document.getElementById('longBtn');
            const shortBtn = document.getElementById('shortBtn');
            const entryPriceInput = document.getElementById('entryPrice');
            const entryPriceResult = document.getElementById('entryPriceResult');
            const leverageInput = document.getElementById('leverage');
            const leverageValue = document.getElementById('leverageValue');
            const leverageWarning = document.getElementById('leverageWarning');
            const atrInput = document.getElementById('atr');
            const riskPercentInput = document.getElementById('riskPercent');
            const riskPercentValue = document.getElementById('riskPercentValue');
            const riskAmountInput = document.getElementById('riskAmount');
            const rewardRatio1Input = document.getElementById('rewardRatio1');
            const rewardRatio1Value = document.getElementById('rewardRatio1Value');
            const rewardRatio2Input = document.getElementById('rewardRatio2');
            const rewardRatio2Value = document.getElementById('rewardRatio2Value');
            const atrValueSpan = document.getElementById('atrValue');
            const previewAtrPercent = document.getElementById('previewAtrPercent');
            const previewAtrPercentValue = document.getElementById('previewAtrPercentValue');
            const stopLossPriceInput = document.getElementById('stopLossPrice');
            const priceDifferenceSpan = document.getElementById('priceDifference');
            const stopLossPercentInput = document.getElementById('stopLossPercent');
            const stopLossPercentValue = document.getElementById('stopLossPercentValue');
            const previewPercentValue = document.getElementById('previewPercentValue');
            const previewPercent = document.getElementById('previewPercent');
            const exchangeFeeInput = document.getElementById('exchangeFee');
            const exchangeFeeResult = document.getElementById('exchangeFeeResult');
            const assetTypeSelect = document.getElementById('assetType');
            const customDecimalsGroup = document.getElementById('customDecimalsGroup');
            const customDecimalsInput = document.getElementById('customDecimals');
            const decimalsInfo = document.getElementById('decimalsInfo');

            // Элементы результатов
            const positionSizeSpan = document.getElementById('positionSize');
            const stopLossSpan = document.getElementById('stopLoss');
            const stopLossPercentSpan = document.getElementById('stopLossPercent');
            const stopLossUsdtSpan = document.getElementById('stopLossUsdt');
            const takeProfitLevelsDiv = document.getElementById('takeProfitLevels');
            const liquidationPriceSpan = document.getElementById('liquidationPrice');
            const liquidationPricePercentSpan = document.getElementById('liquidationPricePercent');
            const atrResultSpan = document.getElementById('atrResult');

            // Переключатели метода ввода стоп-лосса
            const stopMethodButtons = document.querySelectorAll('.stop-method-btn');
            const atrGroup = document.getElementById('atr-group');
            const priceGroup = document.getElementById('price-group');
            const percentGroup = document.getElementById('percent-group');

            // Кнопки типа сделки
            const tradeTypeButtons = document.querySelectorAll('.trade-type-btn');
            const tradeTypeSelector = document.getElementById('tradeTypeSelector');

            // Инициализация
            function init() {
                leverageInput.value = 10;
                leverageValue.textContent = '10x';

                riskPercentInput.value = 10;
                riskPercentValue.textContent = '10';
                previewAtrPercent.textContent = '0.0000 USDT';
                previewAtrPercentValue.textContent = '10%';

                stopLossPercentInput.value = 2;
                stopLossPercentValue.textContent = '2';
                previewPercentValue.textContent = '0.0000 USDT';
                previewPercent.textContent = '2%';

                exchangeFeeInput.value = 0.0500;
                exchangeFeeResult.textContent = '0.0500%';

                updateSliderValues();
                updateAtrPreview();
                updatePercentPreview();
                calculateRisk();

                // Назначение обработчиков событий
                longBtn.addEventListener('click', () => {
                    isLong = true;
                    longBtn.classList.add('active');
                    shortBtn.classList.remove('active');

                    if (isTradeTypeSelectorVisible && isLong) {
                        tradeTypeSelector.style.display = 'none';
                        isTradeTypeSelectorVisible = false;
                    } else {
                        tradeTypeSelector.style.display = 'flex';
                        isTradeTypeSelectorVisible = true;
                        updateTradeTypeButtons();
                    }
                    
                    calculateRisk();
                });

                shortBtn.addEventListener('click', () => {
                    isLong = false;
                    shortBtn.classList.add('active');
                    longBtn.classList.remove('active');

                    if (isTradeTypeSelectorVisible && !isLong) {
                        tradeTypeSelector.style.display = 'none';
                        isTradeTypeSelectorVisible = false;
                    } else {
                        tradeTypeSelector.style.display = 'flex';
                        isTradeTypeSelectorVisible = true;
                        updateTradeTypeButtons();
                    }
                    
                    calculateRisk();
                });

                tradeTypeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tradeType = button.dataset.type;

                        tradeTypeButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        calculateRisk();
                    });
                });

                entryPriceInput.addEventListener('input', function() {
                    const price = this.value;
                    if (price && !isNaN(parseFloat(normalizeNumber(price)))) {
                        const decimals = autoDetectPrecision(price);
                        const decimalsInfo = document.getElementById('decimalsInfo');
                        
                        if (decimals > 0) {
                            decimalsInfo.textContent = `Автоматически определено: ${decimals} знака после запятой`;
                            decimalsInfo.style.display = 'block';
                            
                            assetTypeSelect.value = decimals.toString();
                            
                            if (assetTypeSelect.value === 'custom') {
                                customDecimalsInput.value = decimals;
                                customDecimalsGroup.style.display = 'block';
                            } else {
                                customDecimalsGroup.style.display = 'none';
                            }
                        } else {
                            decimalsInfo.style.display = 'none';
                        }
                    } else {
                        document.getElementById('decimalsInfo').style.display = 'none';
                    }
                    
                    calculateRisk();
                });
                
                leverageInput.addEventListener('input', () => {
                    leverageValue.textContent = leverageInput.value + 'x';
                    if (leverageInput.value > 10) {
                        leverageWarning.style.display = 'block';
                    } else {
                        leverageWarning.style.display = 'none';
                    }
                    calculateRisk();
                });
                atrInput.addEventListener('input', () => {
                    updateAtrPreview();
                    calculateRisk();
                });
                riskPercentInput.addEventListener('input', () => {
                    updateSliderValues();
                    updateAtrPreview();
                    calculateRisk();
                });
                riskAmountInput.addEventListener('input', calculateRisk);
                rewardRatio1Input.addEventListener('input', () => {
                    updateSliderValues();
                    calculateRisk();
                });
                rewardRatio2Input.addEventListener('input', () => {
                    updateSliderValues();
                    calculateRisk();
                });
                exchangeFeeInput.addEventListener('input', () => {
                    exchangeFeeResult.textContent = formatNumber(parseFloat(exchangeFeeInput.value) || 0.0500, 4) + '%';
                    calculateRisk();
                });
                
                assetTypeSelect.addEventListener('change', () => {
                    if (assetTypeSelect.value === 'custom') {
                        customDecimalsGroup.style.display = 'block';
                    } else {
                        customDecimalsGroup.style.display = 'none';
                    }
                    calculateRisk();
                });
                
                customDecimalsInput.addEventListener('input', calculateRisk);

                stopMethodButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        stopMethod = button.dataset.method;

                        stopMethodButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        atrGroup.classList.remove('active');
                        priceGroup.classList.remove('active');
                        percentGroup.classList.remove('active');

                        if (stopMethod === 'atr') {
                            atrGroup.classList.add('active');
                        } else if (stopMethod === 'price') {
                            priceGroup.classList.add('active');
                        } else if (stopMethod === 'percent') {
                            percentGroup.classList.add('active');
                        }

                        calculateRisk();
                    });
                });

                stopLossPriceInput.addEventListener('input', () => {
                    const entryPrice = parseFloat(normalizeNumber(entryPriceInput.value)) || 0;
                    const stopLossPrice = parseFloat(normalizeNumber(stopLossPriceInput.value)) || 0;

                    if (entryPrice > 0 && stopLossPrice > 0) {
                        const difference = Math.abs(entryPrice - stopLossPrice);
                        priceDifferenceSpan.textContent = formatNumber(difference, 8) + ' USDT';
                    } else {
                        priceDifferenceSpan.textContent = '0.0000 USDT';
                    }

                    calculateRisk();
                });

                stopLossPercentInput.addEventListener('input', () => {
                    updateSliderValues();
                    updatePercentPreview();
                    calculateRisk();
                });

                document.getElementById('exportTextBtn').addEventListener('click', exportToText);
                document.getElementById('exportTelegramBtn').addEventListener('click', sendToTelegram);
                document.getElementById('copyCalculationBtn').addEventListener('click', copyCalculationToClipboard);

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser && currentUser.email) {
                    updateUserUI(currentUser.email);
                }
            }

            function updateTradeTypeButtons() {
                const longBreakoutBtn = document.querySelector('.trade-type-btn.long-breakout');
                const longFakeoutBtn = document.querySelector('.trade-type-btn.long-fakeout');
                const shortBreakoutBtn = document.querySelector('.trade-type-btn.short-breakout');
                const shortFakeoutBtn = document.querySelector('.trade-type-btn.short-fakeout');

                if (isLong) {
                    longBreakoutBtn.style.display = '';
                    longFakeoutBtn.style.display = '';
                    shortBreakoutBtn.style.display = 'none';
                    shortFakeoutBtn.style.display = 'none';

                    tradeType = 'long-breakout';
                    longBreakoutBtn.classList.add('active');
                    longFakeoutBtn.classList.remove('active');
                } else {
                    longBreakoutBtn.style.display = 'none';
                    longFakeoutBtn.style.display = 'none';
                    shortBreakoutBtn.style.display = '';
                    shortFakeoutBtn.style.display = '';

                    tradeType = 'short-breakout';
                    shortBreakoutBtn.classList.add('active');
                    shortFakeoutBtn.classList.remove('active');
                }
            }

            function updateSliderValues() {
                riskPercentValue.textContent = riskPercentInput.value;
                rewardRatio1Value.textContent = rewardRatio1Input.value;
                rewardRatio2Value.textContent = rewardRatio2Input.value;
                stopLossPercentValue.textContent = stopLossPercentInput.value;
            }

            function updateAtrPreview() {
                const atr = parseFloat(atrInput.value) || 0;
                const riskPercent = parseFloat(riskPercentInput.value) / 100;

                atrValueSpan.textContent = formatNumber(atr, 8) + ' USDT';
                previewAtrPercent.textContent = formatNumber(atr * riskPercent, 8) + ' USDT';
                previewAtrPercentValue.textContent = riskPercentInput.value + '%';
                atrResultSpan.textContent = formatNumber(atr, 8) + ' USDT';
            }

            function updatePercentPreview() {
                const entryPrice = parseFloat(normalizeNumber(entryPriceInput.value)) || 0;
                const stopLossPercent = parseFloat(stopLossPercentInput.value) / 100;

                if (entryPrice > 0) {
                    const priceDifference = entryPrice * stopLossPercent;
                    previewPercentValue.textContent = formatNumber(priceDifference, 8) + ' USDT';
                    previewPercent.textContent = stopLossPercentInput.value + '%';
                } else {
                    previewPercentValue.textContent = '0.0000 USDT';
                    previewPercent.textContent = stopLossPercentInput.value + '%';
                }
            }

            function calculateRisk() {
                const entryPrice = parseFloat(normalizeNumber(entryPriceInput.value)) || 0;
                const leverage = parseFloat(leverageInput.value) || 1;
                const atr = parseFloat(atrInput.value) || 0;
                const riskPercent = parseFloat(riskPercentInput.value) / 100;
                const riskAmount = parseFloat(riskAmountInput.value) || 0;
                const rewardRatio1 = parseFloat(rewardRatio1Input.value) || 3;
                const rewardRatio2 = parseFloat(rewardRatio2Input.value) || 5;
                const stopLossPriceDirect = parseFloat(normalizeNumber(stopLossPriceInput.value)) || 0;
                const stopLossPercent = parseFloat(stopLossPercentInput.value) / 100 || 0.02;
                const exchangeFee = parseFloat(exchangeFeeInput.value) / 100 || 0.0005;
                const assetType = assetTypeSelect.value;
                const decimalPlaces = assetType === 'custom' ? 
                    parseInt(document.getElementById('customDecimals').value) || 4 : 
                    parseInt(assetType);

                let priceDifference;
                if (stopMethod === 'atr') {
                    priceDifference = atr * riskPercent;
                } else if (stopMethod === 'price') {
                    priceDifference = Math.abs(entryPrice - stopLossPriceDirect);
                } else if (stopMethod === 'percent') {
                    priceDifference = entryPrice * stopLossPercent;
                }

                let stopLossPrice;
                if (stopMethod === 'atr') {
                    stopLossPrice = isLong ? 
                        entryPrice - priceDifference : 
                        entryPrice + priceDifference;
                } else if (stopMethod === 'price') {
                    stopLossPrice = stopLossPriceDirect;
                } else if (stopMethod === 'percent') {
                    stopLossPrice = isLong ? 
                        entryPrice - priceDifference : 
                        entryPrice + priceDifference;
                }

                const positionSize = priceDifference > 0 ? 
                    riskAmount / (priceDifference * (1 + exchangeFee * 2)) : 0;

                const entryFee = entryPrice * positionSize * exchangeFee;
                
                const takeProfit1 = isLong ? 
                    entryPrice + (riskAmount * rewardRatio1 + entryFee + (entryPrice * positionSize * exchangeFee)) / positionSize : 
                    entryPrice - (riskAmount * rewardRatio1 + entryFee + (entryPrice * positionSize * exchangeFee)) / positionSize;
                
                const takeProfit2 = isLong ? 
                    entryPrice + (riskAmount * rewardRatio2 + entryFee + (entryPrice * positionSize * exchangeFee)) / positionSize : 
                    entryPrice - (riskAmount * rewardRatio2 + entryFee + (entryPrice * positionSize * exchangeFee)) / positionSize;

                const liquidationPrice = isLong ? 
                    entryPrice * (1 - 1/leverage) : 
                    entryPrice * (1 + 1/leverage);

                const stopLossPercentValue = calculatePercentageChange(entryPrice, stopLossPrice);
                const takeProfit1Percent = calculatePercentageChange(entryPrice, takeProfit1);
                const takeProfit2Percent = calculatePercentageChange(entryPrice, takeProfit2);
                const liquidationPricePercent = calculatePercentageChange(entryPrice, liquidationPrice);

                const stopLossUsdt = priceDifference * positionSize;

                const exitFee = takeProfit2 * positionSize * exchangeFee;
                const totalFee = entryFee + exitFee;

                entryPriceResult.textContent = `${formatNumber(entryPrice, decimalPlaces, assetType)} USDT`;
                positionSizeSpan.textContent = formatNumber(positionSize, 1);
                stopLossSpan.innerHTML = `${formatNumber(stopLossPrice, decimalPlaces, assetType)} USDT <span class="percentage-value">(${stopLossPercentValue}%)</span><span class="loss-usdt">-${formatNumber(stopLossUsdt, 2)} USDT</span>`;
                liquidationPriceSpan.innerHTML = `${formatNumber(liquidationPrice, decimalPlaces, assetType)} USDT <span class="percentage-value">(${liquidationPricePercent}%)</span>`;
                exchangeFeeResult.textContent = `${formatNumber(exchangeFee * 100, 4)}%`;
                atrResultSpan.textContent = `${formatNumber(atr, 8)} USDT`;

                generateTakeProfitLevels(
                    entryPrice, 
                    stopLossPrice, 
                    isLong, 
                    rewardRatio1, 
                    rewardRatio2, 
                    riskAmount,
                    positionSize, 
                    exchangeFee,
                    decimalPlaces,
                    assetType
                );
            }

            function generateTakeProfitLevels(entryPrice, stopLossPrice, isLong, ratio1, ratio2, riskAmount, positionSize, exchangeFee, decimalPlaces, assetType) {
                takeProfitLevelsDiv.innerHTML = '';

                const priceDifference = Math.abs(entryPrice - stopLossPrice);
                const levels = [ratio1, ratio2];
                const entryFee = entryPrice * positionSize * exchangeFee;

                levels.forEach(ratio => {
                    let takeProfitPrice;
                    let targetProfit = riskAmount * ratio;
                    
                    takeProfitPrice = isLong ? 
                        entryPrice + (targetProfit + entryFee + (entryPrice * positionSize * exchangeFee)) / positionSize : 
                        entryPrice - (targetProfit + entryFee + (entryPrice * positionSize * exchangeFee)) / positionSize;

                    const profitDifference = Math.abs(entryPrice - takeProfitPrice);
                    const grossProfit = profitDifference * positionSize;
                    const exitFee = takeProfitPrice * positionSize * exchangeFee;
                    const profitPercent = calculatePercentageChange(entryPrice, takeProfitPrice);

                    const levelDiv = document.createElement('div');
                    levelDiv.className = 'take-profit-item';
                    levelDiv.innerHTML = `
                        <span class="take-profit-ratio">Тейк-профит 1к${ratio}</span>
                        <span class="take-profit-price">${formatNumber(takeProfitPrice, decimalPlaces, assetType)} USDT <span class="percentage-value">(${profitPercent}%)</span></span>
                        <span class="take-profit-value">+${formatNumber(targetProfit, 1)} USDT (чистая прибыль, комиссия: ${formatNumber(exitFee, 8)} USDT)</span>
                    `;
                    takeProfitLevelsDiv.appendChild(levelDiv);
                });
            }

            init();
        });

        // Функции для раздела предпосылок
        let currentVisibleText = null;
        let currentTvhType = null;

        function toggleText(type) {
            document.querySelectorAll('.text-display').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tvh-sub-buttons').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.algorithm-sub-buttons').forEach(el => el.style.display = 'none');

            if (currentVisibleText === type) {
                currentVisibleText = null;
                document.getElementById('actionButtons').style.display = 'none';
            } else {
                document.getElementById(`${type}Text`).style.display = 'block';
                currentVisibleText = type;
                document.getElementById('actionButtons').style.display = 'flex';
            }
        }

        function toggleTvhButtons(type) {
            document.querySelectorAll('.text-display').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tvh-sub-buttons').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.algorithm-sub-buttons').forEach(el => el.style.display = 'none');
            document.getElementById('actionButtons').style.display = 'none';

            if (currentTvhType === type) {
                currentTvhType = null;
            } else {
                document.getElementById(`${type}Buttons`).style.display = 'flex';
                currentTvhType = type;
            }
        }

        function toggleAlgorithmButtons() {
            document.querySelectorAll('.text-display').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tvh-sub-buttons').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.algorithm-sub-buttons').forEach(el => el.style.display = 'none');
            document.getElementById('actionButtons').style.display = 'none';

            if (currentAlgorithmType === 'algorithm') {
                currentAlgorithmType = null;
            } else {
                document.getElementById('algorithmButtons').style.display = 'flex';
                currentAlgorithmType = 'algorithm';
            }
        }

        function toggleAlgorithmSubButtons(type) {
            document.querySelectorAll('.text-display').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tvh-sub-buttons').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.algorithm-sub-buttons').forEach(el => el.style.display = 'none');
            document.getElementById('actionButtons').style.display = 'none';

            if (type === 'falseBreakthroughAlgorithm') {
                document.getElementById('falseBreakthroughAlgorithmButtons').style.display = 'flex';
                document.getElementById('breakthroughAlgorithmButtons').style.display = 'none';
            } else if (type === 'breakthroughAlgorithm') {
                document.getElementById('breakthroughAlgorithmButtons').style.display = 'flex';
                document.getElementById('falseBreakthroughAlgorithmButtons').style.display = 'none';
            }
        }

        function backToAlgorithmMain() {
            document.querySelectorAll('.text-display').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tvh-sub-buttons').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.algorithm-sub-buttons').forEach(el => el.style.display = 'none');
            document.getElementById('actionButtons').style.display = 'none';

            document.getElementById('algorithmButtons').style.display = 'flex';
            currentAlgorithmType = 'algorithm';
        }

        function showTvhText(type) {
            const tvhTextContent = document.getElementById('tvhTextContent');
            const tvhTextInner = document.getElementById('tvhTextInner');
            const tvhOverlay = document.getElementById('tvhOverlay');
            
            const tvhData = tvhTexts[type];
            
            tvhTextInner.innerHTML = tvhData.text;
            
            tvhTextContent.style.display = 'block';
            tvhOverlay.style.display = 'block';
        }

        function closeTvhText() {
            document.getElementById('tvhTextContent').style.display = 'none';
            document.getElementById('tvhOverlay').style.display = 'none';
        }

        function copyTvhText() {
            const textToCopy = document.getElementById('tvhTextInner').textContent;
            
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    showNotification('Текст скопирован!', 'success');
                })
                .catch(err => {
                    showNotification('Не удалось скопировать текст: ' + err, 'error');
                });
        }

        function getSelectedItems() {
            let selectedItems = [];
            let container = document.getElementById(`${currentVisibleText}Text`);

            if (!container) return [];

            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach((checkbox, index) => {
                const itemText = checkbox.nextElementSibling.textContent.trim();
                selectedItems.push(`${index + 1}. ${itemText}`);
            });

            return selectedItems;
        }

        function getTextContent() {
            const container = document.getElementById(`${currentVisibleText}Text`);
            if (!container) return '';

            if (currentVisibleText.includes('tvh')) {
                return container.textContent.trim();
            }

            const selectedItems = getSelectedItems();
            if (selectedItems.length === 0) return container.querySelector('h3').textContent + '\n' + container.querySelector('p').textContent;

            let textToCopy = container.querySelector('h3').textContent + '\n' + container.querySelector('p').textContent + '\n';
            textToCopy += selectedItems.join('\n');

            return textToCopy;
        }

        function copySelectedText() {
            const textToCopy = getTextContent();

            if (textToCopy === '') {
                showStatus('Нечего копировать', 3000, 'error');
                return;
            }

            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    showStatus('Текст скопирован!', 3000, 'success');
                })
                .catch(err => {
                    showStatus('Не удалось скопировать текст: ' + err, 5000, 'error');
                });
        }

        function exportSelectedToTelegram() {
            const textToSend = getTextContent();

            if (textToSend === '') {
                showStatus('Нечего отправлять', 3000, 'error');
                return;
            }

            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: textToSend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showStatus('Текст успешно отправлен в Telegram!', 3000, 'success');
                } else {
                    showStatus('Ошибка при отправке: ' + data.description, 5000, 'error');
                }
            })
            .catch(error => {
                showStatus('Ошибка: ' + error.message, 5000, 'error');
            });
        }

        function resetCheckboxes() {
            const container = document.getElementById(`${currentVisibleText}Text`);
            if (container) {
                container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                showStatus('Выбор сброшен!', 2000, 'success');
            }
        }

        function showStatus(message, duration, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message ' + type;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, duration);
        }

        // Menu functions
        function showCalculator() {
            toggleMenu();
            window.location.href = 'index.html';
        }

        function showAlerts() {
            toggleMenu();
            window.location.href = 'alerts.html';
        }

        function showLoginForm() {
            toggleMenu();
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.classList.remove('opacity-100', 'pointer-events-auto');
            }
        }

        function showRegisterForm() {
            toggleMenu();
            const modal = document.getElementById('registerModal');
            if (modal) {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }
        }

        function closeRegisterModal() {
            const modal = document.getElementById('registerModal');
            if (modal) {
                modal.classList.remove('opacity-100', 'pointer-events-auto');
            }
        }

        function showTelegramSettings() {
            toggleMenu();
            document.getElementById('telegramSettingsModal').classList.add('active');
        }

        function closeTelegramSettingsModal() {
            document.getElementById('telegramSettingsModal').classList.remove('active');
        }

        function saveTelegramSettings() {
            const botToken = document.getElementById('telegramBotToken').value;
            const chatId = document.getElementById('telegramChatId').value;
            
            localStorage.setItem('telegramBotToken', botToken);
            localStorage.setItem('telegramChatId', chatId);
            
            showNotification('Настройки Telegram сохранены!', 'success');
        }

        function testTelegramConnection() {
            const botToken = document.getElementById('telegramBotToken').value || localStorage.getItem('telegramBotToken');
            const chatId = document.getElementById('telegramChatId').value || localStorage.getItem('telegramChatId');
            
            if (!botToken || !chatId) {
                showNotification('Заполните все поля!', 'error');
                return;
            }
            
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: '✅ Тестовое сообщение от Crypto Tools\nСоединение с Telegram успешно установлено!'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showNotification('Соединение с Telegram успешно!', 'success');
                } else {
                    showNotification('Ошибка: ' + (data.description || 'неизвестная ошибка'), 'error');
                }
            })
            .catch(error => {
                showNotification('Ошибка соединения: ' + error.message, 'error');
            });
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Заполните все поля!', 'error');
                return;
            }
            
            const user = {
                email: email,
                name: email.split('@')[0]
            };
            
            localStorage.setItem('currentUser', JSON.stringify(user));
            updateUserUI(email);
            closeLoginModal();
            showNotification('Вход выполнен успешно!', 'success');
        }

        function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showNotification('Заполните все поля!', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Пароли не совпадают!', 'error');
                return;
            }
            
            const user = {
                email: email,
                name: email.split('@')[0]
            };
            
            localStorage.setItem('currentUser', JSON.stringify(user));
            updateUserUI(email);
            closeRegisterModal();
            showNotification('Регистрация прошла успешно!', 'success');
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            updateUserUI();
            showNotification('Вы вышли из системы', 'success');
        }

        function updateUserUI(email = null) {
            const loginMenuItem = document.getElementById('loginMenuItem');
            const registerMenuItem = document.getElementById('registerMenuItem');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            const userProfileBtn = document.getElementById('userProfileBtn');
            const userName = document.getElementById('userName');
            
            if (email) {
                loginMenuItem.classList.add('hidden');
                registerMenuItem.classList.add('hidden');
                logoutMenuItem.classList.remove('hidden');
                userProfileBtn.classList.remove('hidden');
                userName.textContent = email.split('@')[0];
            } else {
                loginMenuItem.classList.remove('hidden');
                registerMenuItem.classList.remove('hidden');
                logoutMenuItem.classList.add('hidden');
                userProfileBtn.classList.add('hidden');
                userName.textContent = 'Гость';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.email) {
                updateUserUI(currentUser.email);
            }

            const savedBotToken = localStorage.getItem('telegramBotToken');
            const savedChatId = localStorage.getItem('telegramChatId');
            
            if (savedBotToken) {
                document.getElementById('telegramBotToken').value = savedBotToken;
            }
            
            if (savedChatId) {
                document.getElementById('telegramChatId').value = savedChatId;
            }

            document.getElementById('tvhOverlay').addEventListener('click', closeTvhText);
        });

        window.showCalculator = showCalculator;
        window.showAlerts = showAlerts;
        window.showLoginForm = showLoginForm;
        window.closeLoginModal = closeLoginModal;
        window.showRegisterForm = showRegisterForm;
        window.closeRegisterModal = closeRegisterModal;
        window.toggleMenu = toggleMenu;
        window.showTelegramSettings = showTelegramSettings;
        window.closeTelegramSettingsModal = closeTelegramSettingsModal;
        window.saveTelegramSettings = saveTelegramSettings;
        window.testTelegramConnection = testTelegramConnection;
        window.sendToTelegram = sendToTelegram;
        window.copyCalculationToClipboard = copyCalculationToClipboard;
        window.toggleText = toggleText;
        window.toggleTvhButtons = toggleTvhButtons;
        window.toggleAlgorithmButtons = toggleAlgorithmButtons;
        window.toggleAlgorithmSubButtons = toggleAlgorithmSubButtons;
        window.backToAlgorithmMain = backToAlgorithmMain;
        window.showTvhText = showTvhText;
        window.closeTvhText = closeTvhText;
        window.copyTvhText = copyTvhText;
        window.copySelectedText = copySelectedText;
        window.exportSelectedToTelegram = exportSelectedToTelegram;
        window.resetCheckboxes = resetCheckboxes;
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleLogout = handleLogout;
        window.openPhotoModal = openPhotoModal;
        window.closePhotoModal = closePhotoModal;
        window.changePhoto = changePhoto;
        window.selectPhoto = selectPhoto;
        window.zoomIn = zoomIn;
        window.zoomOut = zoomOut;
        window.resetZoom = resetZoom;
        window.toggleFullscreen = toggleFullscreen;
    </script>
</body>
</html>
